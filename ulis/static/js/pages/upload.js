let UploadForm={constants:window.ULISconstant,initializeSelect(i,e){let t=document.getElementById(i);t&&e.forEach(i=>t.add(new Option(i,i)))},initializeUploader(){$("#fileupload").fileinput({language:"vi",showPreview:!0,showUpload:!1,uploadUrl:null,browseOnZoneClick:!0,layoutTemplates:{footer:'<div class="file-thumbnail-footer" style ="height:94px">\n  <input class="kv-input kv-new form-control input-sm form-control-sm text-center {TAG_CSS_NEW} file-name" value="{caption}" placeholder="Enter file name...">\n   <div class="small" style="margin:15px 0 2px 0">{size}</div> {progress}\n{indicator}\n{actions}\n</div>'},maxFileSize:102400,elErrorContainer:"#kartik-file-errors",allowedFileExtensions:["doc","docx","pdf","ppt","pptx","xls","xlsx","png","jpg","jpeg"]})},initialize(){this.initializeSelect("type",this.constants.types),this.initializeSelect("department",this.constants.departments),this.initializeSelect("school_year",this.constants.schoolYears),FormHandler.InitializeFormWatcher(),window.addEventListener("DOMContentLoaded",()=>{turnstile.render("#loadverify",{sitekey:"0x4AAAAAAAFZF3YYiB8JTQ4R"})}),this.initializeWizard(),this.initializeFormValidation(),this.initializeSubmitHandler(),this.initializeUploader()},initializeWizard(){let n=$(".validation-wizard").show();n.steps({headerTag:"h6",bodyTag:"section",transitionEffect:"fade",titleTemplate:'<span class="step">#index#</span> #title#',labels:{finish:"Đăng tải"},onStepChanging:(i,e,t)=>t<e||(n.find(`.body:eq(${t}) label.error`).remove(),n.find(`.body:eq(${t}) .error`).removeClass("error"),n.validate().settings.ignore=":disabled,:hidden",n.valid()),onFinishing:()=>(n.validate().settings.ignore=":disabled",n.valid()),onFinished:()=>$("#confirmModal").modal("show")})},initializeFormValidation(){$(".validation-wizard").validate({ignore:"input[type=hidden]",errorClass:"invalid-feedback",successClass:"text-success",highlight:(i,e)=>$(i).removeClass(e),unhighlight:(i,e)=>$(i).removeClass(e),errorPlacement:(i,e)=>i.insertAfter(e),rules:{email:{email:!0}}})},initializeSubmitHandler(){let i=$("#submitform");rxjs.fromEvent(i,"click").pipe(rxjs.tap(()=>window.ContentHandler.ToggleLoading(i,!0)),rxjs.debounceTime(1e3),rxjs.switchMap(async()=>{var i=document.getElementById("addsub_form");if(i?.checkValidity())try{var e=new FormData(i),t=$("#fileupload")[0],n=(0<t.files.length&&e.append("file",t.files[0]),await fetch(i.getAttribute("action"),{method:"POST",body:e}));if(!n.ok)throw await n.json();window.NotificationHandler.show({type:"success",content:"Tai liệu đã được đăng tải thành công",title:"Đăng tải thành công"});var a=(await n.json()).data;window.location.href="/files/file/"+a._id}catch(i){window.NotificationHandler.show({type:"error",content:i.error,title:"Đăng tải thất bại"}),$("#confirmModal").modal("hide")}else i.classList.add("was-validated")}),rxjs.catchError(i=>(logger.error("Error uploading",i),window.NotificationHandler.show({title:"Lỗi đăng tải",content:"Đã có lỗi xảy ra khi đăng tải tài liệu, vui lòng thử lại sau",type:"error"}),[])),rxjs.tap(()=>window.ContentHandler.ToggleLoading(i,!1))).subscribe()}};UploadForm.initialize();