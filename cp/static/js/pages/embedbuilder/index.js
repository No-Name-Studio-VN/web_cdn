(()=>{const n=document.getElementById("custom-username"),a=document.getElementById("custom-username-wordcount"),o=document.getElementById("custom-avatarurl"),i=document.getElementById("usewebhookinfo"),t=document.getElementById("savewebhookurl"),r=document.getElementById("sendwebhookbtn"),s=document.querySelector("#sendmessageBtn"),l=document.querySelector("#webhookURL"),d=document.getElementById("sendtochannel"),c="https://discord.com/api/",u=c+"webhooks";c;try{var e=localStorage.getItem("ebWebhookURL");e&&p(e)&&(l.value=localStorage.getItem("ebWebhookURL"),$.ajax({url:e,method:"GET",success:function(e){window.ContentHandler.ToggleValidation(l,!0),y(!0),b=e.name,f=e.avatar,t.checked=!0},error:function(e){window.ContentHandler.ToggleValidation(l,!1),y(!1)}}))}catch(e){logger.error("Embedbuilder",e)}document.getElementById("viewport").addEventListener("load",function(){var e=document.querySelector("#placeholder"),t=document.getElementById("viewport");e.remove(),t.style.visibility="visible",s.disabled=!1,s.innerHTML='<i class="ti ti-send-2 d-block d-lg-none d-md-none"></i> <span class="d-none d-lg-block d-md-block">Send to channel</span>',(e=localStorage.getItem("ebUsername"))&&(L("updateUsername",{username:e,save:!1}),n.value=e,a.innerText=e.length+"/80",80<a.innerText||a.innerText<1?(window.ContentHandler.ToggleValidation(n,!1),a.classList.add("bg-danger"),a.classList.remove("bg-success")):(window.ContentHandler.ToggleValidation(n,!0),a.classList.add("bg-success"),a.classList.remove("bg-danger"))),(t=localStorage.getItem("ebAvatarurl"))&&(L("updateAvatar",{avatar:t,save:!1}),o.value=localStorage.getItem("ebAvatarurl"),o.value.length<1||0==h(o.value)?window.ContentHandler.ToggleValidation(o,!1):window.ContentHandler.ToggleValidation(o,!0))});const g=document.querySelector("#displayfullscreeniframe");function m(e){$("html").css("overflow-y",e?"":"hidden")}g.addEventListener("click",function(){var e=document.querySelector("#frameholder");e.classList.contains("fullscreen-div")?(e.classList.remove("fullscreen-div"),g.innerHTML='<i class="ti ti-arrows-maximize"></i>',m(!0)):(e.classList.add("fullscreen-div"),m(!(g.innerHTML='<i class="ti ti-arrows-minimize"></i>')),document.getElementById("viewport").scrollIntoView({behavior:"smooth",block:"center"}))}),document.querySelector("#sendmessageBtn").addEventListener("click",function(){frameholder.classList.contains("fullscreen-div")&&(frameholder.classList.remove("fullscreen-div"),g.innerHTML='<i class="ti ti-arrows-maximize"></i>')});const v=$("#guildselect"),w=$("#channelselect");function h(e){return null!=e.match(/\.(jpeg|jpg|gif|png|webp)(\?.*)?$/)}function p(e){return!!e.startsWith(c)}v.length&&(window.ContentHandler.ToggleMultiSelect(w,{placeholder:"Select a channel"}),v.on("change",function(e){var t=$(this).val();window.DiscordAPIHandler.getChannels(t,{channelType:"GuildText"}).then(e=>{w.empty(),$.each(e,function(e,t){t=$("<option></option>").val(t.id).text("# "+t.name);w.append(t)}),window.ContentHandler.ToggleMultiSelect(w,{placeholder:"Select a channel"}),d.disabled=!1}).catch(e=>{d.disabled=!0,window.NotificationHandler.show({title:"Error",content:e.message,type:"error"})})}));let b,f;function y(e){1==e?(r.disabled=!1,i.disabled=!1,t.disabled=!1):0==e&&(r.disabled=!0,i.disabled=!0,t.disabled=!0)}function L(e,t){document.getElementById("viewport").contentWindow.postMessage({event_id:e||"buildRequest",data:t||null},"*")}l.addEventListener("input",e=>{e=e.target.value;if(!p(e))return y(!1),window.ContentHandler.ToggleValidation(l,!1);$.ajax({url:e,method:"GET",success:function(e){y(!0),window.ContentHandler.ToggleValidation(l,!0),b=e.name,f=`https://cdn.discordapp.com/avatars/${e.id}/${e.avatar}.webp?size=256`},error:function(e){y(!1),window.ContentHandler.ToggleValidation(l,!1)}})}),n.addEventListener("input",function(){var e=this.value.length;a.innerText=e+"/80",80<e||e<1?(window.ContentHandler.ToggleValidation(n,!1),a.classList.add("bg-danger"),a.classList.remove("bg-success")):(L("updateUsername",{username:this.value,save:!0}),window.ContentHandler.ToggleValidation(n,!0),a.classList.add("bg-success"),a.classList.remove("bg-danger"))}),o.addEventListener("input",function(){if(this.value.length<1||0==h(this.value))return window.ContentHandler.ToggleValidation(o,!1);L("updateAvatar",{avatar:this.value,save:!0}),window.ContentHandler.ToggleValidation(o,!0)}),i.addEventListener("click",function(){this.checked?(b&&L("updateUsername",{username:b,save:!1}),L("updateAvatar",{avatar:f||"https://cdn.discordapp.com/embed/avatars/0.png",save:!1})):(L("updateUsername",{username:localStorage.ebUsername,save:!1}),L("updateAvatar",{avatar:localStorage.ebAvatarurl,save:!1}))}),t.addEventListener("click",function(){this.checked?localStorage.setItem("ebWebhookURL",l.value):localStorage.removeItem("ebWebhookURL")}),r.addEventListener("click",async function(){if(p(l.value)){let e=l.value;e.startsWith(u)&&((e=e.replace(u,"https://discord.com/api/v10/webhooks")).includes("?")?(n=e.split("?"),e=n[0]+"?wait=true"):e+="?wait=true");var n={Accept:"application/json","Accept-Language":"en"};let t=localStorage.getItem("embedbuilderjson");t&&(t=JSON.parse(t),1==i.checked?(t.username=b,t.avatar_url=f):(t.username=localStorage.getItem("ebUsername"),t.avatar_url=localStorage.getItem("ebAvatarurl")),"string"==typeof(t=JSON.stringify(t))&&(n["Content-Type"]="application/json"),$.ajax({url:e,method:"POST",data:t,headers:n,success:async function(e,t,n){"0"==n.getResponseHeader("X-RateLimit-Remaining")&&(n=1e3*Number(n.getResponseHeader("X-RateLimit-Reset-After")??2),window.NotificationHandler.show({title:"Error",content:`You are being rate limited. Please try again in ${n/1e3} seconds.`,type:"error"})),window.NotificationHandler.show({title:"Webhook success",content:"Your webhook was sent successfully",type:"success"})},error:function(e){window.NotificationHandler.show({title:"Error",content:e.responseJSON.message,type:"error"})}}))}}),d&&d.addEventListener("click",async function(){var e=w.find(":selected");if(e.length<1)return window.NotificationHandler.show({title:"Error",content:"Please select a channel",type:"error"});e=e.map(e=>e.value);$.ajax({url:"/embedbuilder/sendtochannel",method:"POST",contentType:"application/json",data:JSON.stringify({guildId:v.val(),channelId:e,embedjson:localStorage.getItem("embedbuilderjson")}),success:function(e,t,n){if("0"==n.getResponseHeader("sendtochannel"))return n=1e3*Number(n.getResponseHeader("X-RateLimit-Reset-After")??2),window.NotificationHandler.show({title:"Webhook error",body:`You are being rate limited. Please try again in ${n/1e3} seconds.`,type:"error"});var a=e.data;for(let e=0;e<a.length;e++)"Success"!=a[e].status&&window.NotificationHandler.show({title:"Error sending embed to: "+a[e].channelName,content:a[e].status,type:"error"});window.NotificationHandler.show({title:"Webhook success",content:"Your webhook was sent successfully",type:"success"})},error:function(e){window.NotificationHandler.show({title:"Error",content:e.responseJSON.message,type:"error"})}})})})();